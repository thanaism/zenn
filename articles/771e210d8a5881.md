---
title: 'tRPCã§Edge Runtimeã¨Node.js Runtimeã‚’ä½¿ã„åˆ†ã‘ã‚‹'
emoji: 'ğŸ£'
type: 'tech' # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: [tRPC, edge runtime]
published: true
publication_name: 'synschismo_inc'
---

# ã‚³ãƒ¼ãƒ«ãƒ‰ã‚¹ã‚¿ãƒ¼ãƒˆãŒé‡ã„

Q: é–“é•ã£ã¦æœ‰è±¡ç„¡è±¡ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’å¯†çµåˆã«å°å…¥ã—ã¦ãƒãƒ³ãƒ‰ãƒ«ã‚µã‚¤ã‚ºãŒè‚¥å¤§åŒ–ã—ãŸNext.jsã‚’Vercelã«ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹ã¨ã©ã†ãªã‚‹ã§ã—ã‚‡ã†ã‹ï¼Ÿ

A: ãƒ“ãƒ«ãƒ‰ã¨ã‚³ãƒ¼ãƒ«ãƒ‰ã‚¹ã‚¿ãƒ¼ãƒˆã‚’å¾…ã¤ã ã‘ã§æ—¥ãŒæš®ã‚Œã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

æ ¹æœ¬è§£æ±ºã¯ãƒãƒ³ãƒ‰ãƒ«ã‚µã‚¤ã‚ºã‚’å°ã•ãã™ã‚‹ã“ã¨ã§ã™ãŒã€ãã‚“ãªã“ã¨ãŒä¸€æœä¸€å¤•ã«ã§ãã‚‹ãªã‚‰è‹¦åŠ´ã—ã¾ã›ã‚“ã€‚

ã¨ã„ã†ã“ã¨ã§Edge Runtimeã‚’ä½¿ã„ã¾ã™ã€‚

ã¨è¨€ã„ãŸã„ã¨ã“ã‚ãªã‚“ã§ã™ãŒã€tRPCã§ä¸¡ãƒ©ãƒ³ã‚¿ã‚¤ãƒ ã‚’å…±å­˜ã•ã›ã‚‹ã®ã«è‹¦åŠ´ã—ãŸã®ã§è¨˜äº‹ã«ã—ã¦ãŠãã¾ã™ã€‚

ãªãŠã€ã“ã®è¨˜äº‹ã®å†…å®¹ã¯Stewart Brackenã•ã‚“ã®ä»¥ä¸‹ã®è‹±èªãƒ–ãƒ­ã‚°ã‚’ãƒ™ãƒ¼ã‚¹ã«å¤šå°‘ã®æƒ…å ±ã‚’åŠ ãˆã¦ã„ã¾ã™ã€‚
åŸæ–‡ã‚’ç›´æ¥èª­ã¿ãŸã„æ–¹ã¯ãã¡ã‚‰ã‚’ã©ã†ãï¼š

https://stewartcodes.hashnode.dev/how-to-incrementally-adopt-edge-functions-with-multiple-trpc-backends

# tRPCã§Edge Runtimeã‚’ä½¿ã†

ã‚„ã‚‹ã“ã¨ã¯å¤§ãã3ã¤ã§ã™ã€‚

1. Edge Runtimeç”¨ã®context/routerã‚’ä½œæˆã™ã‚‹
2. Edge Runtimeç”¨ã®API Routeã‚’ä½œæˆã™ã‚‹
3. ä¸¡ãƒ©ãƒ³ã‚¿ã‚¤ãƒ ãŒå…±å­˜ã§ãã‚‹clientã‚’ä½œæˆã™ã‚‹

## Edge Runtimeç”¨ã®context/routerã‚’ä½œæˆã™ã‚‹

ã¾ãšã¯æ—¢å­˜ã®Node.js Runtimeå‘ã‘ã®å®Ÿè£…ã«ãªã‚‰ã£ã¦Edge Runtimeç”¨ã®contextã¨routerã‚’ä½œæˆã—ã¾ã™ã€‚

ã“ã“ã¯ç‰¹ã«å·¥å¤«ã¯å¿…è¦ãªãã€edge-compatibleã«æ›¸ã„ã¦ã‚ã‚Œã°å•é¡Œã‚ã‚Šã¾ã›ã‚“ã€‚

```ts:server/edge/trpc.ts
import { initTRPC, TRPCError } from '@trpc/server';
import superjson from 'superjson';
import { ZodError } from 'zod';

export const createEdgeContext = async () => ({
    // edge-compatible initialization
});

const t = initTRPC.context<unknown>().create({
  transformer: superjson,
  errorFormatter({ shape, error }) {
    return {
      ...shape,
      data: {
        ...shape.data,
        zodError: error.cause instanceof ZodError ? error.cause.flatten() : null,
      },
    };
  },
});

export const createEdgeRouter = t.router;
export const publicEdgeProcedure = t.procedure;
```

```ts:server/edge/root.ts
import type { inferRouterInputs, inferRouterOutputs } from '@trpc/server';
import { createEdgeRouter } from './trpc';

export const edgeRouter = createEdgeRouter({
  // your routers
});

export type EdgeRouter = typeof edgeRouter;
export type EdgeRouterInputs = inferRouterInputs<EdgeRouter>;
export type EdgeRouterOutputs = inferRouterOutputs<EdgeRouter>;
```

ã“ã®ã¨ãã€**edgeRouterã‚’Node.js Runtimeç”¨ã®routerã®ä¸€éƒ¨ã¨ã—ã¦å«ã‚ã¦ãŠãã¾ã™**ã€‚

```ts:server/api/root.ts
export const appRouter = createTRPCRouter({

  // Node.js Runtime routers
  // ...

  edge: edgeRouter, // Add your Edge Runtime router here
});
```

ã“ã‚Œã«ã‚ˆã‚Šã€æœ€å¾Œã«ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’ä½œæˆã™ã‚‹éš›ã«1ã¤ã®ãƒ«ãƒ¼ã‚¿ãƒ¼ã§ä¸¡ãƒ©ãƒ³ã‚¿ã‚¤ãƒ ã®å‹æƒ…å ±ã‚’åˆ©ç”¨ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

## Edge Runtimeç”¨ã®API Routeã‚’ä½œæˆã™ã‚‹

æ¬¡ã«Edge Runtimeç”¨ã®API Routeã‚’ä½œæˆã—ã¾ã™ã€‚

ã“ã®éš›ã€`fetchRequestHandler`ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚

```ts:app/api/edge/[trpc]/route.ts
import { NextRequest } from 'next/server';
import { fetchRequestHandler } from '@trpc/server/adapters/fetch';
import { createEdgeContext } from '~/server/edge/trpc';
import { edgeRouter } from '~/server/edge/root';

async function handler(req: NextRequest) {
  return fetchRequestHandler({
    req,
    endpoint: '/api/edge',
    router: edgeRouter,
    createContext: createEdgeContext,
  });
}

export const runtime = 'edge';
export { handler as GET, handler as POST };
```

## ä¸¡ãƒ©ãƒ³ã‚¿ã‚¤ãƒ ãŒå…±å­˜ã§ãã‚‹clientã‚’ä½œæˆã™ã‚‹

ã“ã“ãŒä¸€ç•ªã®ãƒã‚¤ãƒ³ãƒˆã§ã™ã€‚

tRPCã®ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã¯ã€å½“ç„¶ãªãŒã‚‰ã‚µãƒ¼ãƒãƒ¼ã®ãƒ©ãƒ³ã‚¿ã‚¤ãƒ ã«ä¾å­˜ã—ãªã„ãŸã‚ã€Edge Runtimeã¨Node.js Runtimeã®ä¸¡æ–¹ã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’ä½œæˆã§ãã‚‹ã¯ãšã§ã™ã€‚

ã—ã‹ã—ã€åŸºæœ¬çš„ã«`createTRPCNext`ã§ã¯1ã¤ã®routerã®æƒ…å ±ã®ã¿ã‚’å—ã‘å–ã‚‹ãŸã‚ã€å·¥å¤«ã—ãªã„ã¨ä¸¡ãƒ©ãƒ³ã‚¿ã‚¤ãƒ ã‚’å…±å­˜ã•ã›ã‚‹ã“ã¨ãŒã§ãã¾ã›ã‚“ã€‚

ä»¥ä¸‹ã®ã‚ˆã†ã«ã‚«ã‚¹ã‚¿ãƒ ãƒªãƒ³ã‚¯ã‚’ç”¨ã„ã¦ã€edgeã®ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ãŒä»˜ã„ã¦ã„ã‚‹å ´åˆã ã‘ãƒ‘ã‚¹ã‚’ãƒªãƒ©ã‚¤ãƒˆã—ã¦Edge Runtimeç”¨ã®API Routeã«ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã™ã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚

```ts:utils/api.ts
export const api = createTRPCNext<AppRouter>({
  config() {
    return {
      transformer: superjson,
      links: [
        (runtime) => {
          const servers = {
            defaultServer: httpBatchLink({ url: `${getBaseUrl()}/api/trpc` })(runtime),
            edge: httpBatchLink({ url: `${getBaseUrl()}/api/edge` })(runtime),
          };

          return (ctx) => {
            const { op } = ctx;
            const pathParts = op.path.split('.');
            const serverName = pathParts[0];

            // Route to edge server if path starts with 'edge.'
            if (serverName === 'edge') {
              pathParts.shift(); // Remove 'edge' prefix
              const path = pathParts.join('.');
              return servers.edge({ ...ctx, op: { ...op, path } });
            }

            return servers.defaultServer(ctx);
          };
        },
      ],
    };
  },
  ssr: false,
});
```

### linksãŒå—ã‘å–ã‚‹å‹

`links`ãŒå°‘ã€…è¤‡é›‘ãªã®ã§ã€å‹ã‚’ç¢ºèªã—ã¦ãŠãã¾ã™ã€‚

ã¾ãšã€`links`ã¯ä»¥ä¸‹ã®å‹ã‚’å—ã‘å–ã‚Šã¾ã™ã€‚

```ts
TRPCLink < TRouter > [];
```

ã“ã“ã§ã€`TRPCLink`ã®å®šç¾©ã¯ä»¥ä¸‹ã§ã™ã€‚

```ts
export type TRPCLink<TRouter extends AnyRouter> = (
  opts: TRPCClientRuntime,
) => OperationLink<TRouter>;
```

å¼•æ•°ã¨ãªã‚‹`opts`ã¯ã€`httpBatchLink`ã«ãã®ã¾ã¾æ¸¡ã•ã‚Œã‚‹ç”¨é€”ã®ãŸã‚ã€æ·±è¿½ã„ã—ã¾ã›ã‚“ã€‚

å•é¡Œã¯ã€å†ã³é–¢æ•°ã¨ã—ã¦è¿”ã‚‹`OperationLink<TRouter>`ã®å®šç¾©ã§ã™ã€‚

```ts
export type OperationLink<TRouter extends AnyRouter, TInput = unknown, TOutput = unknown> = (opts: {
  op: Operation<TInput>;
  next: (op: Operation<TInput>) => OperationResultObservable<TRouter, TOutput>;
}) => OperationResultObservable<TRouter, TOutput>;
```

ãªã‚‹ã»ã©`const { op } = ctx;`ã§å–ã‚Šå‡ºã—ã¦ã„ãŸ`op`ã®å‹å®šç¾©ã«ãŸã©ã‚Šç€ãã¾ã—ãŸã€‚

ã“ã®`op`ã«ãƒ‘ã‚¹ãŒå«ã¾ã‚Œã‚‹ã®ã§ã€ãƒªãƒ©ã‚¤ãƒˆã—ã¦å…ƒã®`httpBatchLink`ã«æ¸¡ã›ã°ã‚ˆã„ã¨ã„ã†ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚

```ts
export type Operation<TInput = unknown> = {
  id: number;
  type: 'mutation' | 'query' | 'subscription';
  input: TInput;
  path: string;
  context: OperationContext;
};
```

# Edge Runtimeã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆå‘¼ã³å‡ºã—

Edge Runtimeã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’å‘¼ã³å‡ºã™éš›ã¯ã€`api.edge`ã‚’åˆ©ç”¨ã—ã¾ã™ã€‚

```ts
const HelloComponent = () => {
  const [hello] = api.edge.hello.useSuspenseQuery();

  return <div>{hello}</div>;
};
```

# ãŠã‚ã‚Šã«

ä»¥ä¸Šã®ã‚ˆã†ã«ã€ã‚«ã‚¹ã‚¿ãƒ ãƒªãƒ³ã‚¯ã‚’å®šç¾©ã—ã¦ã‚ã’ã‚‹ã“ã¨ã§ã€tRPCã§Edge Runtimeã¨Node.js Runtimeã‚’å…±å­˜ã•ã›ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

ç§ã¯å†’é ­ã§ç´¹ä»‹ã—ãŸãƒ–ãƒ­ã‚°ã‚’èª­ã‚€ã¾ã§ã€çµ„ã¿è¾¼ã¿ã®`splitLink`ã‚’ä½¿ã£ã¦ãªã‚“ã¨ã‹ã—ã‚ˆã†ã¨ã—ã¦ã„ãŸã®ã§ã™ãŒã€`splitLink`ã ã¨ä»Šå›å®šç¾©ã—ãŸã‚‚ã®ã¨é•ã£ã¦ãƒ‘ã‚¹ã®ãƒªãƒ©ã‚¤ãƒˆã«ã¯å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚
ãã®ãŸã‚ã€ä»Šå›ã®ã‚ˆã†ã«edgeRouterã‚’ãƒã‚¹ãƒˆã—ãŸ1ã¤ã®routerã‚’åŸºæº–ã«ä½œã‚ã†ã¨ã—ã¦ã‚‚ã€API Routeã«åˆ°é”ã—ãŸã‚ã¨ã®ãƒ‘ã‚¹ä¸ä¸€è‡´ã§ã†ã¾ãå‹•ã‹ã›ã¾ã›ã‚“ã§ã—ãŸã€‚

ä¸€å¿œã€tRPCã®å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«ã¯linksã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã¯[ã‚ã‚Š][0]ã€ã‚«ã‚¹ã‚¿ãƒ ãƒªãƒ³ã‚¯ã®æ§‹ç¯‰ã«ã¤ã„ã¦ã¯è§¦ã‚Œã‚‰ã‚Œã¦ã„ã¾ã™ãŒã€æœ€åˆã«è¦‹ãŸå½“æ™‚ã®ç§ã¯ã¡ã‚ƒã‚“ã¨å‹ã‚’è¿½ã„ãã‚‰ãšè‡ªä½œã‚’è«¦ã‚ãŸè¨˜æ†¶ãŒã‚ã‚Šã¾ã™ã€‚

å®Ÿéš›ã«ã¯ã¨ã¦ã‚‚ã‚·ãƒ³ãƒ—ãƒ«ãªæ‰‹æ³•ã§ã‚¯ãƒªã‚¢ã§ãã‚‹ã¨ã„ã†ã“ã¨ãŒåˆ†ã‹ã‚Šã¾ã—ãŸã®ã§ã€æ¬¡ã«ä¼¼ãŸã‚ˆã†ãªå ´é¢ãŒã‚ã‚Œã°ã€ã‚‚ã†ã¡ã‚‡ã£ã¨ç²˜ã£ã¦çŸ¥æµã‚’çµã‚ã†ã‹ãªã¨æ€ã„ã¾ã™ã€‚

[0]: https://trpc.io/docs/v10/client/links
